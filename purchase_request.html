<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PhilHealth Procurement System</title>
  <style>
    * { box-sizing: border-box; font-family: Arial, Helvetica, sans-serif; }
    body { margin: 0; background-color: #ffffff; color: #000; }

    /* ----- Header & Navbar ----- */
    .header {
  display: flex;
  align-items: center;
  justify-content: space-between; /* added */
  background-color: #8fe04e;
  padding: 10px 20px;
  position: sticky;
  top: 0;
  z-index: 1000;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  transition: background-color 0.3s ease;
}


    .logo {
      display: flex;
      align-items: center;
      margin-right: 50px;
      background: #fff;
      padding: 5px 15px;
      border-radius: 40px;
      transition: transform 0.3s ease;
    }

    .logo:hover { transform: scale(1.05); }
    .logo img { height: 45px; margin-right: 10px; }
    .logo span { font-weight: bold; font-size: 14px; }

    .nav {
      display: flex;
      gap: 30px;
      font-weight: bold;
      font-size: 14px;
      position: relative;
    }

    .nav a {
      text-decoration: none;
      color: #000;
      padding: 5px 0;
      position: relative;
      transition: transform 0.2s ease, color 0.2s ease;
    }

    .nav a::after {
      content: '';
      position: absolute;
      width: 0;
      height: 3px;
      background-color: #000;
      left: 0;
      bottom: -2px;
      transition: width 0.3s ease;
      border-radius: 2px;
    }

    .nav a:hover {
      color: #3c6;
      transform: scale(1.05);
    }

    .nav a:hover::after {
      width: 100%;
    }

    .nav a.active {
      color: #000;
    }

    .nav a.active::after {
      width: 100%;
    }
    .admin-label {
  font-weight: bold;
  font-size: 14px;
  color: #000;
  margin-left: auto; /* pushes it to the right */
  background-color: #fff;
  padding: 5px 10px;
  border-radius: 20px;
}


    /* ----- Table & Inputs ----- */
    table { width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 13px; }
    thead th { border: 1px solid #bfbfbf; background-color: #f2f2f2; padding: 6px; text-align: left; font-weight: bold; cursor: pointer; }
    thead th:hover { background-color: #e5f7d4; }
    tbody td { border: 1px solid #d9d9d9; padding: 4px 6px; height: 28px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    tbody tr:hover { background-color: #eaf4ff; }
    td input { width: 100%; border: none; padding: 4px 6px; font-size: 12.5px; outline: none; }
    td input:focus { background-color: #f2fff0; border: 1px solid #5aa300; }

    select { width: 100%; padding: 4px 6px; font-size: 13px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; }
    .status-select, .procurement-select, .processor-select, .office-select, .expense-select { cursor: pointer; }
    .status-select:focus, .procurement-select:focus, .processor-select:focus, .office-select:focus, .expense-select:focus { outline: none; border-color: #5aa300; box-shadow: 0 0 2px rgba(90, 163, 0, 0.6); }

    .footer { background-color: #8fe04e; text-align: center; padding: 10px; font-weight: bold; margin-top: 40px; }

    /* ----- Paper Size Modal ----- */
    .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); }
    .modal-content { background: #fff; width: 420px; margin: 10% auto; padding: 20px; border-radius: 6px; }
    .modal-header { font-weight: bold; font-size: 16px; margin-bottom: 10px; }
    .paper-size-group label { display: block; margin: 6px 0; font-size: 14px; }
    .modal-buttons { margin-top: 15px; text-align: right; }
    .modal-buttons button { padding: 6px 12px; margin-left: 6px; cursor: pointer; }
    .btn-cancel { background: #ccc; border: none; }
    .btn-confirm { background: #5aa300; color: #fff; border: none; }

    /* ----- Export Buttons ----- */
    .export-buttons { margin: 15px 0; }
    .export-buttons button { padding: 6px 12px; margin-right: 6px; cursor: pointer; border: none; border-radius: 4px; font-size: 13px; transition: transform 0.2s ease; }
    .export-buttons button:hover { transform: scale(1.05); }
    .btn-success { background-color: #5aa300; color: #fff; }
    .btn-danger { background-color: #d9534f; color: #fff; }
    .btn-info { background-color: #5bc0de; color: #fff; }

  </style>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body>

  <div class="header">
    <div class="logo">
      <img src="https://www.parfait.com.ph/images/product-icon/philhealth-icon.png" alt="PhilHealth Logo">
      <span>PhilHealth<br><small>Your Partner in Health</small></span>
    </div>
    <nav class="nav">
      <a href="purchase_request.html" class="active">PURCHASE REQUEST</a>
      <a href="request_for_qoutation.html">REQUEST FOR QUOTATION</a>
      <a href="philgeps_posting.html">PHILGEPS POSTING OF RFQ</a>
      <a href="notice_of_award.html">NOTICE OF AWARD</a>
      <a href="contract.html">CONTRACT</a>
      <a href="supplier_directory.html">SUPPLIER DIRECTORY</a>
    </nav>
    <span class="admin-label">ADMIN</span>

  </div>

  <main class="content">
    <div class="container">
      <input
  id="tableSearch"
  type="text"
  placeholder="ðŸ” Search any column..."
  style="margin-bottom:10px; padding:6px 10px; width:260px; font-size:13px;"
>

      <table>
        <thead>
          <tr>
            <th data-column="0">Control #</th>
            <th data-column="1">Date Received</th>
            <th data-column="2">Expense Code</th>
            <th data-column="3">Particulars</th>
            <th data-column="4">ABC</th>
            <th data-column="5">End User</th>
            <th data-column="6">Office</th>
            <th data-column="7">Procurement Mode</th>
            <th data-column="8">Processor</th>
            <th data-column="9">Status</th>
          </tr>
        </thead>
        <tbody>
          <tr class="main-row">
            <td><input type="text" placeholder="Control #" /></td>
            <td><input type="date" /></td>
            <td>
              <select class="expense-select">
                <option value="">-- Select Expense Code --</option>
                <option value="EC1001">EC1001 â€“ Office Supplies</option>
                <option value="EC1002">EC1002 â€“ IT Equipment</option>
                <option value="EC1003">EC1003 â€“ Furniture</option>
                <option value="EC1004">EC1004 â€“ Maintenance</option>
                <option value="EC1005">EC1005 â€“ Training / Seminar</option>
              </select>
            </td>
            <td><input type="text" placeholder="Particulars" /></td>
            <td><input type="number" placeholder="ABC" /></td>
            <td>
              <select class="enduser-select">
                <option value="">-- Select End User --</option>
              </select>
            </td>
            <td>
              <select class="office-select" onchange="updateEndUser(this)">
                <option value="">-- Select Office --</option>
                <option value="OVP">OVP</option>
                <option value="North">North</option>
                <option value="Central">Central</option>
                <option value="South">South</option>
              </select>
            </td>
            <td>
              <select class="procurement-select">
                <option value="">-- Select Mode --</option>
                <option value="Sec27">Sec. 27 â€“ Competitive Bidding</option>
                <option value="Sec31">Sec. 31 â€“ Direct Contracting</option>
                <option value="Sec32">Sec. 32 â€“ Direct Acquisition</option>
                <option value="Sec33">Sec. 33 â€“ Repeat Order</option>
                <option value="Sec34">Sec. 34 â€“ Small Value Procurement</option>
              </select>
            </td>
            <td>
              <select class="processor-select">
                <option value="">-- Select Processor --</option>
                <option value="Jennie">Jennie</option>
                <option value="Jerve">Jerve</option>
                <option value="Jeorge">Jeorge</option>
                <option value="Ofelia">Ofelia</option>
              </select>
            </td>
            <td>
              <select class="status-select">
                <option value="">-- Status --</option>
                <option value="Ongoing">Ongoing</option>  
                <option value="RTS">RTS</option>
                <option value="Completed">Completed</option>
              </select>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="export-buttons">
        <button class="btn btn-success" onclick="exportToExcel()">Save to Excel (.xlsx)</button>
        <button class="btn btn-danger" onclick="exportToPDF()">Save to PDF</button>
        <button class="btn btn-info" onclick="exportToCSV()">Save to CSV</button>
        <button id="addRowBtn">+</button>
      </div>
    </div>
  </main>

 

  <!-- Paper Size Modal -->
  <div id="paperSizeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">Select Paper Size for PDF</div>
      <div class="paper-size-group">
        <label><input type="radio" name="paperSize" value="a4" checked> A4 (210 Ã— 297 mm)</label>
        <label><input type="radio" name="paperSize" value="letter"> Letter (8.5 Ã— 11 in)</label>
        <label><input type="radio" name="paperSize" value="legal"> Legal (8.5 Ã— 14 in)</label>
        <label><input type="radio" name="paperSize" value="a3"> A3 (297 Ã— 420 mm)</label>
        <label><input type="radio" name="paperSize" value="a5"> A5 (148 Ã— 210 mm)</label>
        <label><input type="radio" name="paperSize" value="tabloid"> Tabloid (11 Ã— 17 in)</label>
      </div>
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closePaperSizeDialog()">Cancel</button>
        <button class="btn-confirm" onclick="confirmPaperSizeAndExport()">Export PDF</button>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script>
const STORAGE_KEY = "pr_table_data";
const tbody = document.querySelector("table tbody");
const addRowBtn = document.getElementById("addRowBtn");
const searchInput = document.getElementById("tableSearch");

let clipboard = null;
let undoStack = [];
const MAX_UNDO = 20;

/* =========================
   SAVE TABLE DATA
========================= */
function saveTableData() {
  const rows = [];
  tbody.querySelectorAll("tr").forEach(row => {
    const data = {
      inputs: [...row.querySelectorAll("input")].map(i => i.value),
      selects: [...row.querySelectorAll("select")].map(s => s.selectedIndex)
    };
    rows.push(data);
  });
  localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
}

/* =========================
   LOAD TABLE DATA
========================= */
function loadTableData() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (!saved) return;
  
  const rows = JSON.parse(saved);
  
  // Clear existing rows except the first
  tbody.querySelectorAll("tr:not(.main-row)").forEach(r => r.remove());
  
  // Restore first row
  const firstRow = tbody.querySelector(".main-row");
  if (rows.length > 0) {
    const firstInputs = firstRow.querySelectorAll("input");
    const firstSelects = firstRow.querySelectorAll("select");
    rows[0].inputs.forEach((val, idx) => {
      if (firstInputs[idx]) firstInputs[idx].value = val;
    });
    rows[0].selects.forEach((idx, i) => {
      if (firstSelects[i]) firstSelects[i].selectedIndex = idx;
    });
    const officeSelect = firstRow.querySelector(".office-select");
    if (officeSelect && officeSelect.value) {
      updateEndUser(officeSelect);
    }
  }
  
  // Restore additional rows
  for (let i = 1; i < rows.length; i++) {
    const row = getTemplateRow();
    const inputs = row.querySelectorAll("input");
    const selects = row.querySelectorAll("select");
    
    rows[i].inputs.forEach((val, idx) => {
      if (inputs[idx]) inputs[idx].value = val;
    });
    rows[i].selects.forEach((idx, j) => {
      if (selects[j]) selects[j].selectedIndex = idx;
    });
    
    tbody.appendChild(row);
    const officeSelect = row.querySelector(".office-select");
    officeSelect.onchange = function() {
      updateEndUser(this);
    };
    if (officeSelect && officeSelect.value) {
      updateEndUser(officeSelect);
    }
  }
}

/* =========================
   ROW TEMPLATE
========================= */
function getTemplateRow() {
  return document.querySelector(".main-row").cloneNode(true);
}

/* =========================
   ADD ROW
========================= */
function addRow(focus = true) {
  saveState();
  const row = getTemplateRow();
  row.querySelectorAll("input").forEach(i => i.value = "");
  row.querySelectorAll("select").forEach(s => s.selectedIndex = 0);
  
  // Reattach the office select change listener for the new row
  const officeSelect = row.querySelector(".office-select");
  officeSelect.onchange = function() {
    updateEndUser(this);
  };
  
  tbody.appendChild(row);
  if (focus) row.querySelector("input, select")?.focus();
  saveTableData();
}
addRowBtn.onclick = () => addRow();

/* =========================
   UNDO SYSTEM
========================= */
function saveState() {
  const snapshot = [...tbody.rows].map(r => ({
    inputs: [...r.querySelectorAll("input")].map(i => i.value),
    selects: [...r.querySelectorAll("select")].map(s => s.selectedIndex)
  }));
  undoStack.push(snapshot);
  if (undoStack.length > MAX_UNDO) undoStack.shift();
}

function restoreState(state) {
  tbody.innerHTML = "";
  state.forEach(data => {
    const row = getTemplateRow();
    row.querySelectorAll("input").forEach((i, idx) => i.value = data.inputs[idx] || "");
    row.querySelectorAll("select").forEach((s, idx) => s.selectedIndex = data.selects[idx] || 0);
    tbody.appendChild(row);
  });
  saveTableData();
}

/* =========================
   ARROW KEY NAVIGATION
========================= */
function moveFocus(el, key) {
  const row = el.closest("tr");
  const cells = [...row.querySelectorAll("input, select")];
  const index = cells.indexOf(el);

  let target;
  if (key === "ArrowRight") target = cells[index + 1];
  if (key === "ArrowLeft") target = cells[index - 1];
  if (key === "ArrowDown") {
    const next = row.nextElementSibling;
    target = next?.querySelectorAll("input, select")[index];
  }
  if (key === "ArrowUp") {
    const prev = row.previousElementSibling;
    target = prev?.querySelectorAll("input, select")[index];
  }

  if (target) {
    target.focus();
    if (target.tagName === "INPUT") target.select();
  }
}

/* =========================
   SEARCH FILTER
========================= */
searchInput.addEventListener("input", () => {
  const q = searchInput.value.toLowerCase();
  [...tbody.rows].forEach(row => {
    const match = row.innerText.toLowerCase().includes(q);
    row.style.display = match ? "" : "none";
  });
});

/* =========================
   KEYBOARD SHORTCUTS
========================= */
document.addEventListener("keydown", e => {
  const active = document.activeElement;
  const isField = active && (active.tagName === "INPUT" || active.tagName === "SELECT");

  /* Ctrl shortcuts */
  if (e.ctrlKey) {
    const key = e.key.toLowerCase();

    if (key === "f") {
      e.preventDefault();
      addRow();
    }

    if (key === "c" && isField) {
      e.preventDefault();
      const row = active.closest("tr");
      clipboard = {
        inputs: [...row.querySelectorAll("input")].map(i => i.value),
        selects: [...row.querySelectorAll("select")].map(s => s.selectedIndex)
      };
    }

    if (key === "v" && clipboard) {
      e.preventDefault();
      saveState();
      const row = getTemplateRow();
      row.querySelectorAll("input").forEach((i, idx) => i.value = clipboard.inputs[idx] || "");
      row.querySelectorAll("select").forEach((s, idx) => s.selectedIndex = clipboard.selects[idx] || 0);
      tbody.appendChild(row);
      saveTableData();
    }

    if (key === "z") {
      e.preventDefault();
      if (undoStack.length) restoreState(undoStack.pop());
    }
    return;
  }

  /* Arrow navigation */
  if (isField && ["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)) {
    e.preventDefault();
    moveFocus(active, e.key);
  }
});

/* =========================
   ADD AUTO-SAVE ON CHANGE
========================= */
document.addEventListener("change", (e) => {
  if (e.target.tagName === "INPUT" || e.target.tagName === "SELECT") {
    saveTableData();
  }
});

/* =========================
   OFFICE TO END USER MAPPING
========================= */
const officeEndUserMap = {
  "OVP": ["OVP", "ITMU", "LEGAL", "HCDMD", "PAU", "MSD", "HRMU", "PSMU", "FMS", "CASHIERING", "SBAC"],
  "North": ["BRANCH", "LHIO CALOOCAN", "LHIO Mandaluyong", "LHIO MANILA", "LHIO DMW OFP", "LHIO Valenzuela"],
  "Central": ["BRANCH", "LHIO QUEZON CITY", "LHIO FAIRVIEW", "LHIO RIZAL"],
  "South": ["BRANCH", "LHIO MAKATI", "LHIO PASIG", "LHIO LAS PIÃ‘AS", "LHIO PARAÃ‘AQUE", "GLOBAL Satellite Office"]
};

/* =========================
   UPDATE END USER BASED ON OFFICE
========================= */
function updateEndUser(officeSelect) {
  const row = officeSelect.closest("tr");
  const endUserSelect = row.querySelector(".enduser-select");
  const selectedOffice = officeSelect.value;

  // Clear the End User dropdown
  endUserSelect.innerHTML = '<option value="">-- Select End User --</option>';

  // If an office is selected, populate End User options
  if (selectedOffice && officeEndUserMap[selectedOffice]) {
    const endUsers = officeEndUserMap[selectedOffice];
    endUsers.forEach(endUser => {
      const option = document.createElement("option");
      option.value = endUser;
      option.textContent = endUser;
      endUserSelect.appendChild(option);
    });
  }
}

/* =========================
   PAGE LOAD
========================= */
document.addEventListener("DOMContentLoaded", () => {
  loadTableData();
  // Reattach listeners to initial row
  const initialRow = tbody.querySelector(".main-row");
  const officeSelect = initialRow.querySelector(".office-select");
  officeSelect.onchange = function() {
    updateEndUser(this);
  };
});

/* =========================
   SAVE BEFORE LEAVING PAGE
========================= */
window.addEventListener("beforeunload", () => {
  saveTableData();
});

/* =========================
   EXPORT FUNCTIONS
========================= */
function exportToExcel() {
  const table = document.querySelector("table");
  const workbook = XLSX.utils.table_to_book(table);
  const filename = `purchase_request_${new Date().toISOString().split("T")[0]}.xlsx`;
  XLSX.writeFile(workbook, filename);
}

function exportToCSV() {
  const table = document.querySelector("table");
  const csv = [];
  const rows = table.querySelectorAll("tr");
  
  rows.forEach(row => {
    const cols = row.querySelectorAll("td, th");
    const csvRow = [];
    cols.forEach(col => {
      const input = col.querySelector("input, select");
      csvRow.push(input ? input.value : col.textContent.trim());
    });
    csv.push(csvRow.join(","));
  });
  
  const filename = `purchase_request_${new Date().toISOString().split("T")[0]}.csv`;
  const link = document.createElement("a");
  link.href = "data:text/csv;charset=utf-8," + encodeURIComponent(csv.join("\n"));
  link.download = filename;
  link.click();
}

function exportToPDF() {
  document.getElementById("paperSizeModal").style.display = "block";
}

function closePaperSizeDialog() {
  document.getElementById("paperSizeModal").style.display = "none";
}

</script>
<script>
function confirmPaperSizeAndExport() {
  const selected = document.querySelector('input[name="paperSize"]:checked').value;

  // jsPDF-safe page size mapping (mm)
  const pageSizes = {
    a4: "a4",
    letter: "letter",
    legal: "legal",
    a3: [420, 297],      // A3 landscape
    a5: [210, 148],      // A5 landscape
    tabloid: [432, 279]  // Tabloid landscape
  };

  const format = pageSizes[selected] || "a4";

  closePaperSizeDialog();
  

  const element = document.querySelector("table");

  const opt = {
    margin: 10,
    filename: `purchase_request_${new Date().toISOString().split("T")[0]}.pdf`,
    image: { type: "jpeg", quality: 0.98 },
    html2canvas: {
      scale: 2,
      scrollX: 0,
      scrollY: 0
    },
    jsPDF: {
      unit: "mm",
      format: format,
      orientation: "landscape"
    }
  };

  html2pdf().set(opt).from(element).save();
}

</script>


</body>
</html>
